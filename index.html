<script>
    document.addEventListener("DOMContentLoaded", function () {
        const sendButton = document.getElementById("sendButton");
        const voiceButton = document.getElementById("voiceButton");
        const userInput = document.getElementById("userInput");
        const chatbox = document.getElementById("chatbox");

        if (!sendButton || !voiceButton || !userInput || !chatbox) {
            console.error("‚ùå Error: Missing required elements in HTML.");
            return;
        }

        function sendMessage(message = null) {
            let userMessage = message || userInput.value.trim();
            if (!userMessage) return;

            let userDiv = document.createElement("div");
            userDiv.textContent = "You: " + userMessage;
            userDiv.classList.add("user-message");
            chatbox.appendChild(userDiv);

            fetch("https://smokeshop-chatbot.onrender.com/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "message": userMessage })
            })
            .then(response => response.json())
            .then(data => {
                let botDiv = document.createElement("div");
                botDiv.textContent = "Bot: " + (data.response || "No response received");
                botDiv.classList.add("bot-message");
                chatbox.appendChild(botDiv);
                chatbox.scrollTop = chatbox.scrollHeight;
            })
            .catch(error => {
                console.error("Error:", error);
                let errorDiv = document.createElement("div");
                errorDiv.textContent = "Error: Unable to connect to chatbot.";
                errorDiv.classList.add("error-message");
                chatbox.appendChild(errorDiv);
            });

            userInput.value = "";
        }

        sendButton.addEventListener("click", function () {
            sendMessage(userInput.value);
        });

        userInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage(userInput.value);
            }
        });

        // üéôÔ∏è FIX: Prevent multiple recognition starts
        if ("webkitSpeechRecognition" in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";
            let isRecognizing = false; // New flag to track recognition state

            voiceButton.addEventListener("click", function () {
                if (isRecognizing) {
                    console.warn("Speech recognition is already running.");
                    return;
                }
                isRecognizing = true;
                recognition.start();
                voiceButton.textContent = "üéôÔ∏è Listening...";
            });

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessage(transcript);
                voiceButton.textContent = "üéôÔ∏è Speak";
            };

            recognition.onspeechend = function () {
                recognition.stop();
                isRecognizing = false; // Reset flag
                voiceButton.textContent = "üéôÔ∏è Speak";
            };

            recognition.onerror = function (event) {
                console.error("Voice recognition error:", event.error);
                isRecognizing = false; // Reset flag
                voiceButton.textContent = "üéôÔ∏è Speak";
                alert("Voice recognition error: " + event.error);
            };
        } else {
            voiceButton.style.display = "none";
            console.warn("‚ö†Ô∏è Voice recognition not supported in this browser.");
        }
    });
</script>

