<script>
    document.addEventListener("DOMContentLoaded", function () {
        const sendButton = document.getElementById("sendButton");
        const voiceButton = document.getElementById("voiceButton");
        const userInput = document.getElementById("userInput");
        const chatbox = document.getElementById("chatbox");

        if (!sendButton || !voiceButton || !userInput) {
            console.error("âŒ Error: Missing required elements in HTML.");
            return;
        }

        function sendMessage(message = null) {
            let userMessage = message || userInput.value.trim();
            if (!userMessage) return; // Prevent empty messages

            // Display user message in chatbox
            let userDiv = document.createElement("div");
            userDiv.textContent = "You: " + userMessage;
            userDiv.classList.add("user-message");
            chatbox.appendChild(userDiv);

            // Send request to chatbot API
            fetch("https://smokeshop-chatbot.onrender.com/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "message": userMessage })
            })
            .then(response => response.json())
            .then(data => {
                let botDiv = document.createElement("div");
                botDiv.textContent = "Bot: " + (data.response || "No response received");
                botDiv.classList.add("bot-message");
                chatbox.appendChild(botDiv);
                chatbox.scrollTop = chatbox.scrollHeight;
            })
            .catch(error => {
                console.error("Error:", error);
                let errorDiv = document.createElement("div");
                errorDiv.textContent = "Error: Unable to connect to chatbot.";
                errorDiv.classList.add("error-message");
                chatbox.appendChild(errorDiv);
            });

            userInput.value = "";
        }

        // Fix: Pass the correct message to sendMessage function
        sendButton.addEventListener("click", function () {
            sendMessage(userInput.value);
        });

        userInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage(userInput.value);
            }
        });

        if ("webkitSpeechRecognition" in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";

            voiceButton.addEventListener("click", function () {
                recognition.start();
            });

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessage(transcript);
            };

            recognition.onerror = function (event) {
                console.error("Voice recognition error:", event.error);
            };
        } else {
            voiceButton.style.display = "none";
            console.warn("Speech Recognition is not supported in this browser.");
        }
    });
</script>

